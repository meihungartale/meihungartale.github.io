<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>定時音效提醒工具</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h2 {
      font-size: 28px;
      text-align: center;
      width: 100%;
    }
    .container {
      display: flex;
      gap: 2rem;
      justify-content: center;
      align-items: flex-start;
      margin-top: 2rem;
      max-width: 1000px;
    }
    .sidebar {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 1rem;
      background-color: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 260px;
    }
    .sidebar h3 {
      font-size: 18px;
      margin-bottom: 1rem;
    }
    .sidebar button {
      width: 100%;
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 10px;
      font-size: 16px;
      background-color: #e0e0e0;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .sidebar button:hover {
      background-color: #ccc;
    }
    .sound-btn.active-sound-btn {
      background-color: #ffc107;
      font-weight: bold;
      border: 2px solid #ff9800;
    }
    .card {
      background-color: white;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      flex-grow: 1;
    }
    .input-group {
      margin-bottom: 2rem;
    }
    input[type=number] {
      -moz-appearance: textfield;
      appearance: textfield;
      width: 100%;
      height: 50px;
      font-size: 20px;
      padding: 0 16px;
      border-radius: 10px;
      border: 1px solid #ccc;
      outline: none;
      transition: border-color 0.3s;
    }
    input[type=number]:focus {
      border-color: #007bff;
    }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    #progressWrapper {
      display: none;
      margin-top: 1.5rem;
      margin-bottom: 1.5rem;
    }
    #progressBarContainer {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
    }
    #progressBar {
      width: 100%;
      height: 30px;
      background-color: #f5e1c5;
      text-align: center;
      color: black;
      line-height: 30px;
      font-size: 18px;
      transform-origin: left center;
    }
    #buttonGroup {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }
    #buttonGroup button {
      width: 300px;
      height: 300px;
      font-size: 30px;
      margin: 1rem;
      border-radius: 20px;
      border: none;
      color: black;
      background-color: #f5e1c5;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.1s;
    }
    #buttonGroup button:hover {
      background-color: #e4cba9;
    }
    #buttonGroup button:active {
      transform: scale(0.98);
    }
    .progress-container {
      width: 100%;
      max-width: 1000px;
      padding: 0 1.5rem;
      margin-top: 1rem;
      background-color: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    input[type=range] {
      width: 100%;
      height: 6px;
      background: #ddd;
      border-radius: 5px;
      outline: none;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 18px;
      width: 18px;
      border-radius: 50%;
      background: #ffc107;
      cursor: pointer;
      box-shadow: 0 0 2px rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>
  <h2>🔔 叫 AI 寫的音效提醒工具</h2>

  <div class="progress-container">
    <div id="progressWrapper">
      <div id="progressBarContainer">
        <div id="progressBar">0 秒</div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="sidebar">
      <h3>請選擇你要的通知聲</h3>
      <button id="soundBtn0" class="sound-btn">一般</button>
      <button id="soundBtn1" class="sound-btn">哆啦A夢道具聲</button>
      <span>﹝缺音效 欠投稿﹞</span>
      <span>meihungartale@gmail.com</span>
      <span style="margin-top:12px;">是不是有攻略網.. ??</span>
      <div style="margin-top:1rem; width:100%;">
        <label for="volumeControl" style="font-size:16px; display:block; margin-bottom:8px;">🔊 音量</label>
        <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="0.3">
      </div>
    </div>
    <div class="card">
      <div class="input-group">
        <label for="intervalInput" style="display:block; font-size:18px; margin-bottom:8px;">提醒間隔（秒）：</label>
        <input type="number" id="intervalInput" value="285" min="1">
      </div>
      <div id="buttonGroup">
        <button id="startButton">▶️ 開始</button>
      </div>
    </div>
  </div>

  <script>
    let audioCtx, gainNode, audioBuffer;
    let currentSoundIndex = 0;
    let intervalSeconds, startTime, nextTime;
    let rafId, schedulerTimeoutId;
    let pendingSources = [];

    function initAudioContext() {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      gainNode = audioCtx.createGain();
      gainNode.connect(audioCtx.destination);
    }

    const sounds = ['ww.mp3', 'Doraemon_item.mp3'];
    const soundButtons = [
      document.getElementById('soundBtn0'),
      document.getElementById('soundBtn1')
    ];

    soundButtons.forEach((btn, i) => {
      btn.addEventListener('click', async () => await selectSound(i));
    });

    async function selectSound(index) {
      currentSoundIndex = index;
      soundButtons.forEach(b => b.classList.remove('active-sound-btn'));
      soundButtons[index].classList.add('active-sound-btn');
      if (!audioCtx) initAudioContext();
      const url = sounds[index];
      const resp = await fetch(url);
      const arrayBuffer = await resp.arrayBuffer();
      audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
    }

    document.getElementById('volumeControl')
      .addEventListener('input', e => {
        if (gainNode) gainNode.gain.value = e.target.value;
      });

    document.getElementById('startButton')
      .addEventListener('click', async () => {
        const v = parseInt(document.getElementById('intervalInput').value, 10);
        if (isNaN(v) || v < 1) return alert('請輸入有效秒數（≥1）');
        const btn = document.getElementById('startButton');
        btn.disabled = true;

        if (!audioBuffer) {
          try {
            await selectSound(currentSoundIndex);
          } catch {
            alert('音訊載入失敗，請確認檔案位於同一資料夾');
            btn.disabled = false;
            return;
          }
        }

        await audioCtx.resume();
        start();
        btn.disabled = false;
      });

    function start() {
      intervalSeconds = parseInt(document.getElementById('intervalInput').value, 10);
      cancelAnimationFrame(rafId);
      clearTimeout(schedulerTimeoutId);
      pendingSources.forEach(src => { try { src.stop(); } catch {} });
      pendingSources = [];

      document.getElementById('progressWrapper').style.display = 'block';
      startTime = audioCtx.currentTime;
      nextTime = startTime + intervalSeconds;

      scheduleNext();
      updateProgress();

      document.getElementById('buttonGroup').innerHTML = `
        <button onclick="restart()">🔁 重新開始</button>
        <button onclick="stop()">⏹ 結束</button>
      `;
    }

    function scheduleNext() {
      const src = audioCtx.createBufferSource();
      src.buffer = audioBuffer;
      src.connect(gainNode);
      pendingSources.push(src);
      src.start(nextTime);

      nextTime += intervalSeconds;
      const now = audioCtx.currentTime;
      const msUntilNext = (nextTime - now - 0.1) * 1000;
      schedulerTimeoutId = setTimeout(scheduleNext, Math.max(0, msUntilNext));
    }

    function updateProgress() {
      const now = audioCtx.currentTime;
      let elapsed = (now - startTime) % intervalSeconds;
      if (elapsed < 0) elapsed += intervalSeconds;
      const remaining = Math.ceil(intervalSeconds - elapsed);
      const percent = ((intervalSeconds - elapsed) / intervalSeconds) * 100;

      const bar = document.getElementById('progressBar');
      bar.style.width = `${percent}%`;
      bar.textContent = `${remaining} 秒`;

      rafId = requestAnimationFrame(updateProgress);
    }

    function restart() {
      stop();
      start();
    }

    function stop() {
      cancelAnimationFrame(rafId);
      clearTimeout(schedulerTimeoutId);
      pendingSources.forEach(src => { try { src.stop(); } catch {} });
      pendingSources = [];

      document.getElementById('progressWrapper').style.display = 'none';
      document.getElementById('buttonGroup').innerHTML = `
        <button id="startButton">▶️ 開始</button>
      `;
      document.getElementById('startButton')
        .addEventListener('click', async () => {
          const v = parseInt(document.getElementById('intervalInput').value, 10);
          if (isNaN(v) || v < 1) return alert('請輸入有效秒數（≥1）');
          const btn = document.getElementById('startButton');
          btn.disabled = true;
          if (!audioBuffer) {
            try { await selectSound(currentSoundIndex); } catch { alert('音訊載入失敗'); btn.disabled = false; return; }
          }
          await audioCtx.resume();
          start();
          btn.disabled = false;
        });
    }

    window.addEventListener('load', () => {
      selectSound(0).catch(() => {});
    });
  </script>
</body>
</html>
